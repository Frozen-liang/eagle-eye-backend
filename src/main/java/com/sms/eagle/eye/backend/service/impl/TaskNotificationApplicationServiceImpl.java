package com.sms.eagle.eye.backend.service.impl;

import com.sms.eagle.eye.backend.common.enums.NotificationChannelType;
import com.sms.eagle.eye.backend.convert.ConfigMetadataConverter;
import com.sms.eagle.eye.backend.domain.entity.TaskAlertNotificationEntity;
import com.sms.eagle.eye.backend.domain.service.TaskAlertNotificationService;
import com.sms.eagle.eye.backend.model.ConfigMetadata;
import com.sms.eagle.eye.backend.model.NotificationEvent;
import com.sms.eagle.eye.backend.model.UserInfo;
import com.sms.eagle.eye.backend.notification.Channel;
import com.sms.eagle.eye.backend.notification.impl.ChannelProxy;
import com.sms.eagle.eye.backend.request.task.TaskAlertNotificationAddRequest;
import com.sms.eagle.eye.backend.request.task.TaskAlertNotificationUpdateRequest;
import com.sms.eagle.eye.backend.resolver.ConfigMetadataResolver;
import com.sms.eagle.eye.backend.response.channel.ChannelFieldResponse;
import com.sms.eagle.eye.backend.response.channel.ChannelFieldWithValueResponse;
import com.sms.eagle.eye.backend.response.task.TaskAlertNotificationResponse;
import com.sms.eagle.eye.backend.service.TaskNotificationApplicationService;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import org.apache.commons.collections4.CollectionUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Service;

@Service
public class TaskNotificationApplicationServiceImpl implements TaskNotificationApplicationService {

    private final Channel channel;
    private final ConfigMetadataResolver configMetadataResolver;
    private final ConfigMetadataConverter configMetadataConverter;
    private final TaskAlertNotificationService taskAlertNotificationService;

    public TaskNotificationApplicationServiceImpl(
        @Qualifier(ChannelProxy.CHANNEL_PROXY) Channel channel, ConfigMetadataResolver configMetadataResolver,
        ConfigMetadataConverter configMetadataConverter,
        TaskAlertNotificationService taskAlertNotificationService) {
        this.channel = channel;
        this.configMetadataResolver = configMetadataResolver;
        this.configMetadataConverter = configMetadataConverter;
        this.taskAlertNotificationService = taskAlertNotificationService;
    }

    @Override
    public List<TaskAlertNotificationResponse> getAlertNotification(Long taskId, Integer alarmLevel) {
        List<TaskAlertNotificationEntity> taskAlertNotifications = taskAlertNotificationService
            .getByTaskIdAndAlarmLevel(taskId, alarmLevel);
        if (CollectionUtils.isNotEmpty(taskAlertNotifications)) {
            return taskAlertNotifications.stream().map(taskAlertNotificationEntity -> {
                Map<String, String> map = configMetadataResolver
                    .convertConfigToMap(taskAlertNotificationEntity.getChannelInput());

                TaskAlertNotificationResponse response = TaskAlertNotificationResponse.builder().build();
                List<ChannelFieldResponse> channelFields = channel.getTaskInputFields(response.getChannelType());
                List<ChannelFieldWithValueResponse> inputFields = channelFields.stream().map(channelFieldResponse -> {
                    ChannelFieldWithValueResponse valueResponse = ChannelFieldWithValueResponse.builder().build();
                    BeanUtils.copyProperties(channelFieldResponse, valueResponse);
                    String value = configMetadataResolver.decryptToFrontendValue(
                        configMetadataConverter.fromChannelField(channelFieldResponse), map);
                    valueResponse.setValue(value);
                    return valueResponse;
                }).collect(Collectors.toList());
                response.setInput(inputFields);
                return response;
            }).collect(Collectors.toList());
        } else {
            return Collections.emptyList();
        }
    }

    @Override
    public boolean addAlertNotification(TaskAlertNotificationAddRequest request) {
        List<ConfigMetadata> metadataList = channel.getTaskInputFields(request.getChannelType()).stream()
                .map(configMetadataConverter::fromChannelField).collect(Collectors.toList());
        String encryptValue = configMetadataResolver.checkAndEncrypt(metadataList, request.getChannelInput(), null);
        request.setChannelInput(encryptValue);
        taskAlertNotificationService.addByRequest(request);
        return true;
    }

    @Override
    public boolean updateAlertNotification(TaskAlertNotificationUpdateRequest request) {
        TaskAlertNotificationEntity entity = taskAlertNotificationService
            .getEntityById(request.getAlertNotificationId());
        List<ConfigMetadata> metadataList = channel.getTaskInputFields(entity.getChannelType()).stream()
            .map(configMetadataConverter::fromChannelField).collect(Collectors.toList());
        String encryptValue = configMetadataResolver.checkAndEncrypt(
            metadataList, request.getChannelInput(), entity.getChannelInput());
        request.setChannelInput(encryptValue);
        taskAlertNotificationService.updateByRequest(request);
        return true;
    }

    @Override
    public boolean deleteAlertNotification(Long alertNotificationId) {
        taskAlertNotificationService.delete(alertNotificationId);
        return true;
    }

    @Override
    public void test() {

//        String input = "{\"subject\":\"Eagle Eye Test\",\"receiver\":[\"xiangzhen.xiong@starlight-sms.com\"],"
//            + "\"copyTo\":[\"xiangzhen.xiong@starlight-sms.com\"]}";
        String input = "{\"subject\":\"EagleEyeTest\",\"receiver\":\"[\\\"xiangzhen.xiong@starlight-sms.com\\\"]\","
            + "\"copyTo\":\"[\\\"xiangzhen.xiong@starlight-sms.com\\\"]\"}";
        UserInfo userInfo = UserInfo.builder()
            .username("xiangzhen.xiong")
            .nickname("熊")
            .build();
        String template = "\n"
            + "    <!doctype html>\n"
            + "    <html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n"
            + "      <head>\n"
            + "        <title>\n"
            + "          \n"
            + "        </title>\n"
            + "        <!--[if !mso]><!-->\n"
            + "        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n"
            + "        <!--<![endif]-->\n"
            + "        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">\n"
            + "        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n"
            + "        <style type=\"text/css\">\n"
            + "          #outlook a { padding:0; }\n"
            + "          body { margin:0;padding:0;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%; }\n"
            + "          table, td { border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt; }\n"
            + "          img { border:0;height:auto;line-height:100%; outline:none;text-decoration:none;-ms-interpolation-mode:bicubic; }\n"
            + "          p { display:block;margin:13px 0; }\n"
            + "        </style>\n"
            + "        <!--[if mso]>\n"
            + "        <xml>\n"
            + "        <o:OfficeDocumentSettings>\n"
            + "          <o:AllowPNG/>\n"
            + "          <o:PixelsPerInch>96</o:PixelsPerInch>\n"
            + "        </o:OfficeDocumentSettings>\n"
            + "        </xml>\n"
            + "        <![endif]-->\n"
            + "        <!--[if lte mso 11]>\n"
            + "        <style type=\"text/css\">\n"
            + "          .mj-outlook-group-fix { width:100% !important; }\n"
            + "        </style>\n"
            + "        <![endif]-->\n"
            + "        \n"
            + "      <!--[if !mso]><!-->\n"
            + "        <link href=\"https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700\" rel=\"stylesheet\" type=\"text/css\">\n"
            + "        <style type=\"text/css\">\n"
            + "          @import url(https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700);\n"
            + "        </style>\n"
            + "      <!--<![endif]-->\n"
            + "\n"
            + "    \n"
            + "        \n"
            + "    <style type=\"text/css\">\n"
            + "      @media only screen and (min-width:480px) {\n"
            + "        .mj-column-per-100 { width:100% !important; max-width: 100%; }\n"
            + ".mj-column-per-50 { width:50% !important; max-width: 50%; }\n"
            + ".mj-column-per-40 { width:40% !important; max-width: 40%; }\n"
            + ".mj-column-per-60 { width:60% !important; max-width: 60%; }\n"
            + "      }\n"
            + "    </style>\n"
            + "    \n"
            + "  \n"
            + "        <style type=\"text/css\">\n"
            + "        \n"
            + "        \n"
            + "        </style>\n"
            + "        \n"
            + "        \n"
            + "      </head>\n"
            + "      <body style=\"word-spacing:normal;background-color:#fce7b4;\">\n"
            + "        \n"
            + "        \n"
            + "      <div\n"
            + "         style=\"background-color:#fce7b4;\"\n"
            + "      >\n"
            + "        \n"
            + "      \n"
            + "      <!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]-->\n"
            + "    \n"
            + "      \n"
            + "      <div  style=\"background:#ef6451;background-color:#ef6451;margin:0px auto;max-width:600px;\">\n"
            + "        \n"
            + "        <table\n"
            + "           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#ef6451;background-color:#ef6451;width:100%;\"\n"
            + "        >\n"
            + "          <tbody>\n"
            + "            <tr>\n"
            + "              <td\n"
            + "                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n"
            + "              >\n"
            + "                <!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]-->\n"
            + "            \n"
            + "      <div\n"
            + "         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:40px;line-height:1;text-align:center;color:#ffffff;\"\n"
            + "      >Courier [(${user.username})]</div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "          <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "              </td>\n"
            + "            </tr>\n"
            + "          </tbody>\n"
            + "        </table>\n"
            + "        \n"
            + "      </div>\n"
            + "    \n"
            + "      \n"
            + "      <!--[if mso | IE]></td></tr></table><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]-->\n"
            + "    \n"
            + "      \n"
            + "      <div  style=\"margin:0px auto;max-width:600px;\">\n"
            + "        \n"
            + "        <table\n"
            + "           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;\"\n"
            + "        >\n"
            + "          <tbody>\n"
            + "            <tr>\n"
            + "              <td\n"
            + "                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n"
            + "              >\n"
            + "                <!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]-->\n"
            + "            \n"
            + "      <div\n"
            + "         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:center;color:#000000;\"\n"
            + "      ><h1> Test Report [(${user.nickname})] </h1></div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "          <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "              </td>\n"
            + "            </tr>\n"
            + "          </tbody>\n"
            + "        </table>\n"
            + "        \n"
            + "      </div>\n"
            + "    \n"
            + "      \n"
            + "      <!--[if mso | IE]></td></tr></table><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]-->\n"
            + "    \n"
            + "      \n"
            + "      <div  style=\"margin:0px auto;max-width:600px;\">\n"
            + "        \n"
            + "        <table\n"
            + "           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;\"\n"
            + "        >\n"
            + "          <tbody>\n"
            + "            <tr>\n"
            + "              <td\n"
            + "                 style=\"border:1px solid #000000;direction:ltr;font-size:0px;padding:50px 30px;text-align:center;\"\n"
            + "              >\n"
            + "                <!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" width=\"600px\" ><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:538px;\" width=\"538\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]-->\n"
            + "    \n"
            + "      \n"
            + "      <div  style=\"margin:0px auto;max-width:538px;\">\n"
            + "        \n"
            + "        <table\n"
            + "           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;\"\n"
            + "        >\n"
            + "          <tbody>\n"
            + "            <tr>\n"
            + "              <td\n"
            + "                 style=\"border-left:1px solid #aaaaaa;border-right:1px solid #aaaaaa;border-top:1px solid #aaaaaa;direction:ltr;font-size:0px;padding:20px;text-align:center;\"\n"
            + "              >\n"
            + "                <!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:496px;\" ><![endif]-->\n"
            + "            \n"
            + "      <div\n"
            + "         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"left\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#000000;\"\n"
            + "      ><h2> test-insert question_qu </h2></div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "          <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "              </td>\n"
            + "            </tr>\n"
            + "          </tbody>\n"
            + "        </table>\n"
            + "        \n"
            + "      </div>\n"
            + "    \n"
            + "      \n"
            + "      <!--[if mso | IE]></td></tr></table></td></tr><tr><td class=\"\" width=\"600px\" ><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:538px;\" width=\"538\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]-->\n"
            + "    \n"
            + "      \n"
            + "      <div  style=\"margin:0px auto;max-width:538px;\">\n"
            + "        \n"
            + "        <table\n"
            + "           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;\"\n"
            + "        >\n"
            + "          <tbody>\n"
            + "            <tr>\n"
            + "              <td\n"
            + "                 style=\"border-left:1px solid #aaaaaa;border-right:1px solid #aaaaaa;direction:ltr;font-size:0px;padding:5px;text-align:center;\"\n"
            + "              >\n"
            + "                <!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"width:526px;\" ><![endif]-->\n"
            + "            \n"
            + "      <div\n"
            + "         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0;line-height:0;text-align:left;display:inline-block;width:100%;direction:ltr;\"\n"
            + "      >\n"
            + "        <!--[if mso | IE]><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" ><tr><td style=\"vertical-align:top;width:263px;\" ><![endif]-->\n"
            + "                \n"
            + "      <div\n"
            + "         class=\"mj-column-per-50 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:50%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:center;color:#000000;\"\n"
            + "      ><svg t=\"1635497463016\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" p-id=\"3054\" width=\"100\" height=\"100\">\n"
            + "                <path d=\"M504.781424 15.721105c-278.518842 0-504.301833 225.782991-504.301833 504.301833 0 278.518842 225.782991 504.301833 504.301833 504.301833s504.301833-225.782991 504.301833-504.301833C1009.083256 241.504096 783.299257 15.721105 504.781424 15.721105zM504.781424 983.980624c-256.23677 0-463.957686-207.720916-463.957686-463.957686 0-256.23677 207.720916-463.957686 463.957686-463.957686s463.957686 207.720916 463.957686 463.957686C968.739109 776.259708 761.018193 983.980624 504.781424 983.980624z\" p-id=\"3055\" fill=\"#17abe3\"></path>\n"
            + "                <path d=\"M89.068277 844.954695c0.030258-0.689885 0.070602-1.376744 0.104895-2.06562C89.103578 843.567865 89.068277 844.257749 89.068277 844.954695z\" p-id=\"3056\" fill=\"#17abe3\"></path>\n"
            + "                <path d=\"M504.782432 16.473524c-278.221304 0-503.763238 225.541934-503.763238 503.763238 0 278.222312 225.542943 503.763238 503.763238 503.763238s503.76223-225.540926 503.76223-503.763238C1008.544662 242.015458 783.002727 16.473524 504.782432 16.473524zM504.782432 971.406362c-249.174527 0-451.170609-201.994065-451.170609-451.170609 0-249.174527 201.995073-451.1696 451.170609-451.1696 249.174527 0 451.168591 201.995073 451.168591 451.1696C955.951024 769.412297 753.956959 971.406362 504.782432 971.406362z\" p-id=\"3057\" fill=\"#17abe3\"></path>\n"
            + "                <path d=\"M735.316955 535.007763c0.004034-0.533551 0.020172-1.065085 0.020172-1.599645l-0.111955 0c-1.21335-13.423506-12.491556-23.942234-26.229747-23.942234-14.550116 0-26.343719 11.793603-26.343719 26.342711 0 0.44782 0.012103 0.893623 0.033284 1.335391-1.989975 96.562706-80.865807 174.233257-177.902557 174.233257-97.119456 0-176.043701-77.800661-177.910626-174.471288 0.001009-0.075645 0.006052-0.151291 0.006052-0.227944 0-0.462949-0.012103-0.922872-0.03631-1.37977-0.003026-0.248117-0.013112-0.494216-0.01412-0.742332-0.018155-0.053456-0.03631-0.104895-0.054465-0.157342-1.156868-13.469902-12.451212-24.044103-26.221678-24.044103-13.431575 0-24.504026 10.059813-26.115775 23.053654l-0.20979 0c0 0.72922 0.021181 1.451381 0.027232 2.178584-0.015129 0.362089-0.027232 0.725186-0.027232 1.091309 0 0.58499 0.025215 1.16292 0.063542 1.737824 2.665739 125.01945 104.834265 225.548995 230.492161 225.548995 126.006873 0 228.386197-101.08932 230.505273-226.591891 0.02925-0.518422 0.049422-1.037853 0.049422-1.564344C735.337127 535.539297 735.325024 535.274034 735.316955 535.007763z\" p-id=\"3058\" fill=\"#17abe3\"></path>\n"
            + "                <path d=\"M294.518826 320.253853m-50.430183 0a50 50 0 1 0 100.860367 0 50 50 0 1 0-100.860367 0Z\" p-id=\"3059\" fill=\"#17abe3\"></path>\n"
            + "                <path d=\"M715.04503 335.472674m-50.430183 0a50 50 0 1 0 100.860367 0 50 50 0 1 0-100.860367 0Z\" p-id=\"3060\" fill=\"#17abe3\"></path>\n"
            + "              </svg>\n"
            + "              <h1>2</h1>\n"
            + "              <p>成功个数</p></div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "              <!--[if mso | IE]></td><td style=\"vertical-align:top;width:263px;\" ><![endif]-->\n"
            + "                \n"
            + "      <div\n"
            + "         class=\"mj-column-per-50 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:50%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:center;color:#000000;\"\n"
            + "      ><svg t=\"1635497379809\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" p-id=\"2674\" width=\"100\" height=\"100\">\n"
            + "                <path d=\"M504.781424 15.721105c-278.518842 0-504.301833 225.782991-504.301833 504.301833 0 278.518842 225.782991 504.301833 504.301833 504.301833s504.301833-225.782991 504.301833-504.301833C1009.083256 241.504096 783.299257 15.721105 504.781424 15.721105zM504.781424 983.980624c-256.23677 0-463.957686-207.720916-463.957686-463.957686 0-256.23677 207.720916-463.957686 463.957686-463.957686s463.957686 207.720916 463.957686 463.957686C968.739109 776.259708 761.018193 983.980624 504.781424 983.980624z\" p-id=\"2675\" fill=\"#d81e06\"></path>\n"
            + "                <path d=\"M89.068277 844.954695c0.030258-0.689885 0.070602-1.376744 0.104895-2.06562C89.103578 843.567865 89.068277 844.257749 89.068277 844.954695z\" p-id=\"2676\" fill=\"#d81e06\"></path>\n"
            + "                <path d=\"M504.782432 16.473524c-278.221304 0-503.763238 225.541934-503.763238 503.763238 0 278.222312 225.542943 503.763238 503.763238 503.763238s503.76223-225.540926 503.76223-503.763238C1008.544662 242.015458 783.002727 16.473524 504.782432 16.473524zM504.782432 971.406362c-249.174527 0-451.170609-201.994065-451.170609-451.170609 0-249.174527 201.995073-451.1696 451.170609-451.1696 249.174527 0 451.168591 201.995073 451.168591 451.1696C955.951024 769.412297 753.956959 971.406362 504.782432 971.406362z\" p-id=\"2677\" fill=\"#d81e06\"></path>\n"
            + "                <path d=\"M274.245892 738.421941c-0.004034 0.533551-0.020172 1.065085-0.020172 1.599645l0.111955 0c1.21335 13.423506 12.491556 23.942234 26.229747 23.942234 14.550116 0 26.343719-11.793603 26.343719-26.342711 0-0.44782-0.012103-0.893623-0.033284-1.335391 1.989975-96.562706 80.865807-174.233257 177.902557-174.233257 97.118447 0 176.042692 77.800661 177.910626 174.471288-0.001009 0.075645-0.006052 0.151291-0.006052 0.227944 0 0.462949 0.012103 0.922872 0.035301 1.37977 0.003026 0.248117 0.013112 0.494216 0.015129 0.742332 0.018155 0.053456 0.03631 0.104895 0.054465 0.157342 1.156868 13.469902 12.451212 24.044103 26.221678 24.044103 13.431575 0 24.505035-10.059813 26.116783-23.053654l0.208781 0c0-0.72922-0.021181-1.451381-0.027232-2.178584 0.015129-0.362089 0.027232-0.725186 0.027232-1.091309 0-0.58499-0.025215-1.16292-0.063542-1.737824-2.665739-125.01945-104.835274-225.548995-230.492161-225.548995-126.006873 0-228.386197 101.08932-230.506282 226.591891-0.02925 0.518422-0.049422 1.037853-0.049422 1.564344C274.22572 737.890407 274.237824 738.15567 274.245892 738.421941z\" p-id=\"2678\" fill=\"#d81e06\"></path>\n"
            + "                <path d=\"M294.518826 320.253853m-50.430183 0a50 50 0 1 0 100.860367 0 50 50 0 1 0-100.860367 0Z\" p-id=\"2679\" fill=\"#d81e06\"></path>\n"
            + "                <path d=\"M715.04503 335.472674m-50.430183 0a50 50 0 1 0 100.860367 0 50 50 0 1 0-100.860367 0Z\" p-id=\"2680\" fill=\"#d81e06\"></path>\n"
            + "              </svg>\n"
            + "              <h1>1</h1>\n"
            + "              <p>失败个数</p></div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "              <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "      </div>\n"
            + "    \n"
            + "          <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "              </td>\n"
            + "            </tr>\n"
            + "          </tbody>\n"
            + "        </table>\n"
            + "        \n"
            + "      </div>\n"
            + "    \n"
            + "      \n"
            + "      <!--[if mso | IE]></td></tr></table></td></tr><tr><td class=\"\" width=\"600px\" ><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:538px;\" width=\"538\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]-->\n"
            + "    \n"
            + "      \n"
            + "      <div  style=\"margin:0px auto;max-width:538px;\">\n"
            + "        \n"
            + "        <table\n"
            + "           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;\"\n"
            + "        >\n"
            + "          <tbody>\n"
            + "            <tr>\n"
            + "              <td\n"
            + "                 style=\"border-bottom:1px solid #aaaaaa;border-left:1px solid #aaaaaa;border-right:1px solid #aaaaaa;direction:ltr;font-size:0px;padding:20px;text-align:center;\"\n"
            + "              >\n"
            + "                <!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"width:496px;\" ><![endif]-->\n"
            + "            \n"
            + "      <div\n"
            + "         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0;line-height:0;text-align:left;display:inline-block;width:100%;direction:ltr;\"\n"
            + "      >\n"
            + "        <!--[if mso | IE]><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" ><tr><td style=\"vertical-align:top;width:198px;\" ><![endif]-->\n"
            + "                \n"
            + "      <div\n"
            + "         class=\"mj-column-per-40 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:40%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border:1px solid #dddddd;vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"left\" style=\"font-size:0px;padding:20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#000000;\"\n"
            + "      >执行时间（ms）</div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:0 20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <p\n"
            + "         style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:100%;\"\n"
            + "      >\n"
            + "      </p>\n"
            + "      \n"
            + "      <!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:156px;\" role=\"presentation\" width=\"156px\" ><tr><td style=\"height:0;line-height:0;\"> &nbsp;\n"
            + "</td></tr></table><![endif]-->\n"
            + "    \n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"left\" style=\"font-size:0px;padding:20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#000000;\"\n"
            + "      >延时时间（ms）</div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:0 20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <p\n"
            + "         style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:100%;\"\n"
            + "      >\n"
            + "      </p>\n"
            + "      \n"
            + "      <!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:156px;\" role=\"presentation\" width=\"156px\" ><tr><td style=\"height:0;line-height:0;\"> &nbsp;\n"
            + "</td></tr></table><![endif]-->\n"
            + "    \n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"left\" style=\"font-size:0px;padding:20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:left;color:#000000;\"\n"
            + "      >参数时间（ms）</div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "              <!--[if mso | IE]></td><td style=\"vertical-align:top;width:297px;\" ><![endif]-->\n"
            + "                \n"
            + "      <div\n"
            + "         class=\"mj-column-per-60 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:60%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-bottom:1px solid #dddddd;border-right:1px solid #dddddd;border-top:1px solid #dddddd;vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:center;color:#000000;\"\n"
            + "      >1</div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:0 20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <p\n"
            + "         style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:100%;\"\n"
            + "      >\n"
            + "      </p>\n"
            + "      \n"
            + "      <!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:256px;\" role=\"presentation\" width=\"256px\" ><tr><td style=\"height:0;line-height:0;\"> &nbsp;\n"
            + "</td></tr></table><![endif]-->\n"
            + "    \n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:center;color:#000000;\"\n"
            + "      >2</div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:0 20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <p\n"
            + "         style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:100%;\"\n"
            + "      >\n"
            + "      </p>\n"
            + "      \n"
            + "      <!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-top:dashed 1px lightgrey;font-size:1px;margin:0px auto;width:256px;\" role=\"presentation\" width=\"256px\" ><tr><td style=\"height:0;line-height:0;\"> &nbsp;\n"
            + "</td></tr></table><![endif]-->\n"
            + "    \n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" style=\"font-size:0px;padding:20px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <div\n"
            + "         style=\"font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:13px;line-height:1;text-align:center;color:#000000;\"\n"
            + "      >3</div>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "              <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "      </div>\n"
            + "    \n"
            + "          <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "              </td>\n"
            + "            </tr>\n"
            + "          </tbody>\n"
            + "        </table>\n"
            + "        \n"
            + "      </div>\n"
            + "    \n"
            + "      \n"
            + "      <!--[if mso | IE]></td></tr></table></td></tr></table><![endif]-->\n"
            + "              </td>\n"
            + "            </tr>\n"
            + "          </tbody>\n"
            + "        </table>\n"
            + "        \n"
            + "      </div>\n"
            + "    \n"
            + "      \n"
            + "      <!--[if mso | IE]></td></tr></table><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" style=\"width:600px;\" width=\"600\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]-->\n"
            + "    \n"
            + "      \n"
            + "      <div  style=\"margin:0px auto;max-width:600px;\">\n"
            + "        \n"
            + "        <table\n"
            + "           align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"width:100%;\"\n"
            + "        >\n"
            + "          <tbody>\n"
            + "            <tr>\n"
            + "              <td\n"
            + "                 style=\"direction:ltr;font-size:0px;padding:20px 0;text-align:center;\"\n"
            + "              >\n"
            + "                <!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]-->\n"
            + "            \n"
            + "      <div\n"
            + "         class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0px;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%;\"\n"
            + "      >\n"
            + "        \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top;\" width=\"100%\"\n"
            + "      >\n"
            + "        <tbody>\n"
            + "          \n"
            + "              <tr>\n"
            + "                <td\n"
            + "                   align=\"center\" vertical-align=\"middle\" style=\"font-size:0px;padding:10px 25px;word-break:break-word;\"\n"
            + "                >\n"
            + "                  \n"
            + "      <table\n"
            + "         border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:separate;line-height:100%;\"\n"
            + "      >\n"
            + "        <tr>\n"
            + "          <td\n"
            + "             align=\"center\" bgcolor=\"#f45e43\" role=\"presentation\" style=\"border:none;border-radius:3px;cursor:auto;mso-padding-alt:10px 25px;background:#f45e43;\" valign=\"middle\"\n"
            + "          >\n"
            + "            <a\n"
            + "               href=\"https://nerko.smsassist.com:8888\" style=\"display:inline-block;background:#f45e43;color:white;font-family:Helvetica;font-size:13px;font-weight:normal;line-height:120%;margin:0;text-decoration:none;text-transform:none;padding:10px 25px;mso-padding-alt:0px;border-radius:3px;\" target=\"_blank\"\n"
            + "            >\n"
            + "              查看详情\n"
            + "            </a>\n"
            + "          </td>\n"
            + "        </tr>\n"
            + "      </table>\n"
            + "    \n"
            + "                </td>\n"
            + "              </tr>\n"
            + "            \n"
            + "        </tbody>\n"
            + "      </table>\n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "          <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "              </td>\n"
            + "            </tr>\n"
            + "          </tbody>\n"
            + "        </table>\n"
            + "        \n"
            + "      </div>\n"
            + "    \n"
            + "      \n"
            + "      <!--[if mso | IE]></td></tr></table><![endif]-->\n"
            + "    \n"
            + "    \n"
            + "      </div>\n"
            + "    \n"
            + "      </body>\n"
            + "    </html>\n"
            + "  ";

        NotificationEvent notificationEvent = NotificationEvent.builder()
            .channelType(NotificationChannelType.EMAIL.getValue())
            .channelInput(input)
            .variableKey("user")
            .variable(userInfo)
            .contentTemplate(template)
            .build();
        channel.notify(notificationEvent);

    }
}